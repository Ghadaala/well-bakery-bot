<p>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body {
  font-family: Tahoma, sans-serif;
  background-color: #f5f2e7;
  padding: 20px;
  direction: rtl;
}
section {
  margin-bottom: 40px;
}
h2 {
  color: #4e342e;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: center;
}
button {
  margin-top: 10px;
  padding: 8px 12px;
  background-color: #6d4c41;
  color: white;
  border: none;
  cursor: pointer;
  border-radius: 4px;
}
canvas {
  margin-top: 20px;
}
</style>
</head>

<body>

<section id="table-section">
  <h2>ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
  <div id="data-table">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
  <button onclick="downloadCSV()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ CSV</button>
  <button onclick="downloadExcel()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Excel</button>
</section>

<section id="charts-section">
  <h2>ğŸ“ˆ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©</h2>
  <canvas id="chart1" width="400"></canvas>
  <canvas id="chart2" width="400"></canvas>
  <canvas id="chart3" width="400"></canvas>
  <button onclick="downloadChartsPDF()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ… PDF</button>
</section>

<section id="analytics-section">
  <h2>ğŸ“‹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª</h2>
  <div id="analytics">
    Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...
  </div>
  <button onclick="downloadAnalyticsTXT()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª TXT</button>
</section>

<script>
const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTmdTPRwt6Vt7_qg1XXrUqk5aOyVnpztlR7L7A-St11H1H0E6r2-PgqAOCAAT1oM2cxSyHczcv6HMNa/pub?output=csv";
let data = [];

function parseCSV(csv) {
  return csv.split('\n').map(row => row.split(','));
}

function renderTable(data) {
  let html = "<table><thead><tr>";
  data[0].forEach(h => html += `<th>${h}</th>`);
  html += "</tr></thead><tbody>";

  for (let i = 1; i < data.length; i++) {
    html += "<tr>";
    data[i].forEach(c => html += `<td>${c}</td>`);
    html += "</tr>";
  }

  html += "</tbody></table>";
  document.getElementById("data-table").innerHTML = html;
}

// ØªØ­Ù…ÙŠÙ„ CSV
function downloadCSV() {
  const bom = "\uFEFF";
  const csvContent = bom + data.map(r => r.join(",")).join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Ø§Ù„Ø·Ù„Ø¨Ø§Øª.csv";
  a.click();
  URL.revokeObjectURL(url);
}

// ØªØ­Ù…ÙŠÙ„ Excel
function downloadExcel() {
  const tableHTML = document.querySelector("#data-table table").outerHTML.replace(/ /g, '%20');
  const a = document.createElement("a");
  a.href = 'data:application/vnd.ms-excel,' + tableHTML;
  a.download = 'Ø§Ù„Ø·Ù„Ø¨Ø§Øª.xls';
  a.click();
}

// Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
function drawCharts() {
  const orders = {};
  const sizes = {};
  const days = {};

  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const orderType = row[3].split("-")[0]?.trim();  // Ù†ÙˆØ¹ Ø§Ù„Ù‚Ù‡ÙˆØ©
    const size = row[3].split("-")[1]?.trim();       // Ø§Ù„Ø­Ø¬Ù…
    const day = row[5]?.split(",")[0];              // Ø§Ù„ØªØ§Ø±ÙŠØ®

    orders[orderType] = (orders[orderType] || 0) + 1;
    sizes[size] = (sizes[size] || 0) + 1;
    days[day] = (days[day] || 0) + 1;
  }

  new Chart(document.getElementById("chart1"), {
    type: "bar",
    data: {
      labels: Object.keys(orders),
      datasets: [{ label: "Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù‚Ù‡ÙˆØ©", data: Object.values(orders), backgroundColor: "#6d4c41" }]
    }
  });

  new Chart(document.getElementById("chart2"), {
    type: "pie",
    data: {
      labels: Object.keys(sizes),
      datasets: [{
        label: "Ø§Ù„Ø£Ø­Ø¬Ø§Ù…",
        data: Object.values(sizes),
        backgroundColor: [
          "#FF6384",  // ÙˆØ±Ø¯ÙŠ
          "#36A2EB",  // Ø£Ø²Ø±Ù‚
          "#6d4c41"   // Ø¨Ù†ÙŠ
        ]
      }]
    },
    options: {
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });

  new Chart(document.getElementById("chart3"), {
    type: "line",
    data: {
      labels: Object.keys(days),
      datasets: [{ label: "Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…", data: Object.values(days), borderColor: "#6d4c41", fill: false }]
    }
  });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ… PDF
function downloadChartsPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("ğŸ“ˆ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©", 10, 10);

  ["chart1", "chart2", "chart3"].forEach((id, idx) => {
    const canvas = document.getElementById(id);
    const imgData = canvas.toDataURL("image/png");
    doc.addImage(imgData, 'PNG', 10, 20 + idx * 60, 180, 50);
  });

  doc.save("Ø§Ù„Ø±Ø³ÙˆÙ…-Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©.pdf");
}

// Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
function renderAnalytics() {
  const totalOrders = data.length - 1;

  const orderCounts = {};
  const sizeCounts = {};
  const dateCounts = {};

  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const orderType = row[3].split("-")[0]?.trim();
    const size = row[3].split("-")[1]?.trim();
    const date = row[5]?.split(",")[0];

    orderCounts[orderType] = (orderCounts[orderType] || 0) + 1;
    sizeCounts[size] = (sizeCounts[size] || 0) + 1;
    dateCounts[date] = (dateCounts[date] || 0) + 1;
  }

  const mostOrdered = Object.keys(orderCounts).reduce((a,b) => orderCounts[a] > orderCounts[b] ? a : b);
  const mostSize = Object.keys(sizeCounts).reduce((a,b) => sizeCounts[a] > sizeCounts[b] ? a : b);
  const busiestDay = Object.keys(dateCounts).reduce((a,b) => dateCounts[a] > dateCounts[b] ? a : b);

  const html = `
    <p>ğŸ”· <b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</b> ${totalOrders}</p>
    <p>â˜• <b>Ø£ÙƒØ«Ø± Ù†ÙˆØ¹ Ù‚Ù‡ÙˆØ© Ø·Ù„Ø¨Ù‹Ø§:</b> ${mostOrdered} (${orderCounts[mostOrdered]})</p>
    <p>ğŸ“ <b>Ø£ÙƒØ«Ø± Ø­Ø¬Ù… Ø·Ù„Ø¨Ù‹Ø§:</b> ${mostSize} (${sizeCounts[mostSize]})</p>
    <p>ğŸ“… <b>Ø£ÙƒØ«Ø± ÙŠÙˆÙ… Ø§Ø²Ø¯Ø­Ø§Ù…Ù‹Ø§:</b> ${busiestDay} (${dateCounts[busiestDay]})</p>
  `;

  document.getElementById("analytics").innerHTML = html;
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª TXT
function downloadAnalyticsTXT() {
  const text = document.getElementById("analytics").innerText;
  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª.txt";
  a.click();
  URL.revokeObjectURL(url);
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¨Ø¯Ø¡ ÙƒÙ„ Ø´ÙŠØ¡
fetch(csvURL)
  .then(res => res.text())
  .then(csv => {
    data = parseCSV(csv);
    renderTable(data);
    drawCharts();
    renderAnalytics();
  })
  .catch(err => {
    document.getElementById("data-table").innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
    console.error(err);
  });
</script>

</body>
</html>


</p>